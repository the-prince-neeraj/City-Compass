<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Compass - BMTC Bus Guide</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        deepBlue: '#03045E',
                        oceanBlue: '#0077B6',
                        skyBlue: '#00B4D8',
                        lightSky: '#90E0EF',
                        paleWater: '#CAF0F8',
                        metroPurple: '#9333EA',
                        metroGreen: '#16A34A',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #CAF0F8; color: #03045E; overflow-x: hidden; }
        .hero-bg { background: linear-gradient(135deg, #03045E 0%, #0077B6 100%); border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; }
        .custom-input { border: 2px solid #90E0EF; transition: all 0.3s ease; }
        .custom-input:focus { border-color: #0077B6; box-shadow: 0 0 0 4px rgba(0, 119, 182, 0.1); }
        .suggestions-list::-webkit-scrollbar { width: 6px; }
        .suggestions-list::-webkit-scrollbar-track { background: #CAF0F8; }
        .suggestions-list::-webkit-scrollbar-thumb { background: #00B4D8; border-radius: 3px; }
        #animation-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #CAF0F8; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .bus-card { transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid #0077B6; }
        .bus-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(3, 4, 94, 0.15); }
        .metro-card { border-left: 5px solid #9333EA; background: linear-gradient(to right, #FAF5FF, #fff); }
        .via-stops span:not(:last-child)::after { content: "â€¢"; margin: 0 6px; color: #00B4D8; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <nav class="bg-white shadow-md p-4 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-compass text-oceanBlue text-3xl"></i>
                <h1 class="text-xl font-bold text-deepBlue tracking-wide">CITY COMPASS</h1>
            </div>
            <div class="hidden md:flex items-center gap-4 text-sm font-semibold">
                <span class="text-gray-500">Powered by</span>
                <span class="bg-oceanBlue text-white px-2 py-1 rounded text-xs">BMTC AVLS</span>
              <span class="bg-oceanBlue text-white px-2 py-1 rounded text-xs">GOOGLE</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow">
        
        <!-- SEARCH VIEW -->
        <div id="search-view" class="block">
            <div class="hero-bg text-white pt-16 pb-28 px-4 text-center shadow-lg">
                <h2 class="text-4xl md:text-6xl font-bold mb-4 drop-shadow-md">Find Your Route</h2>
                <p class="text-lightSky text-lg mb-8 font-light tracking-wider">Route Tracking | Real Timings | Bus Route</p>
                
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg mx-auto text-left relative z-10 border-t-4 border-oceanBlue">
                    
                    <!-- From Input -->
                    <div class="mb-5 relative">
                        <label class="block text-deepBlue text-sm font-bold mb-2">
                            <i class="fa-solid fa-circle-dot text-oceanBlue mr-2"></i>From Location
                        </label>
                        <input type="text" id="from-input" placeholder="e.g. Kempegowda Bus Station" autocomplete="off"
                            class="w-full px-4 py-3 rounded-xl custom-input focus:outline-none text-gray-700 bg-paleWater">
                        <ul id="from-suggestions" class="suggestions-list absolute w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden z-20"></ul>
                    </div>

                    <!-- Swap Button -->
                    <div class="flex justify-center -my-5 relative z-10">
                        <button onclick="swapLocations()" class="bg-white hover:bg-lightSky text-oceanBlue rounded-full p-3 border-2 border-oceanBlue transition shadow-md duration-300">
                            <i class="fa-solid fa-arrow-right-arrow-left"></i>
                        </button>
                    </div>

                    <!-- To Input -->
                    <div class="mb-5 relative mt-2">
                        <label class="block text-deepBlue text-sm font-bold mb-2">
                            <i class="fa-solid fa-location-dot text-red-500 mr-2"></i>To Location
                        </label>
                        <input type="text" id="to-input" placeholder="e.g. Jaya Prakash Nagar" autocomplete="off"
                            class="w-full px-4 py-3 rounded-xl custom-input focus:outline-none text-gray-700 bg-paleWater">
                        <ul id="to-suggestions" class="suggestions-list absolute w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden z-20"></ul>
                    </div>

                    <!-- Time Input -->
                    <div class="mb-8 relative">
                        <label class="block text-deepBlue text-sm font-bold mb-2">
                            <i class="fa-regular fa-clock text-oceanBlue mr-2"></i>Departure Time
                        </label>
                        <input type="time" id="time-input" 
                            class="w-full px-4 py-3 rounded-xl custom-input focus:outline-none text-gray-700 bg-paleWater font-sans text-deepBlue">
                    </div>

                    <button onclick="startJourney()" class="w-full bg-oceanBlue hover:bg-deepBlue text-white font-bold py-4 px-4 rounded-xl transition duration-300 shadow-lg transform active:scale-95 flex justify-center items-center gap-2">
                        SEARCH ROUTES <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
            </div>

            <!-- Quick Links / Popular Routes -->
            <div class="container mx-auto mt-12 px-4">
                <h3 class="text-xl font-bold text-deepBlue mb-6 text-center border-b-2 border-skyBlue inline-block mx-auto pb-1">Frequent Routes</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <div class="bg-white p-4 rounded-xl shadow-md border border-lightSky hover:shadow-lg transition cursor-pointer" onclick="fillSearch('Jaya Prakash Nagar 6th Phase', 'Kempegowda Bus Station')">
                        <span class="block text-oceanBlue font-extrabold text-xl">215H</span>
                        <span class="text-xs text-gray-500">JP Nagar - KBS</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-lightSky hover:shadow-lg transition cursor-pointer" onclick="fillSearch('Hebbala', 'Central Silk Board')">
                        <span class="block text-oceanBlue font-extrabold text-xl">500D</span>
                        <span class="text-xs text-gray-500">Hebbal - Silk Board</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-lightSky hover:shadow-lg transition cursor-pointer" onclick="fillSearch('Kempegowda Bus Station', 'Koramangala TTMC')">
                        <span class="block text-oceanBlue font-extrabold text-xl">171</span>
                        <span class="text-xs text-gray-500">KBS - Koramangala</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-lightSky hover:shadow-lg transition cursor-pointer" onclick="fillSearch('Whitefield', 'Kempegowda Bus Station')">
                        <span class="block text-oceanBlue font-extrabold text-xl">335G</span>
                        <span class="text-xs text-gray-500">Whitefield - KBS</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS VIEW -->
        <div id="results-view" class="hidden container mx-auto px-4 py-8 max-w-4xl">
            <button onclick="goBack()" class="mb-6 text-oceanBlue hover:text-deepBlue font-semibold flex items-center gap-2 transition">
                <i class="fa-solid fa-arrow-left"></i> Modify Search
            </button>
            
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-oceanBlue">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end">
                    <div>
                        <p class="text-xs text-skyBlue uppercase tracking-widest font-bold">Trip Details</p>
                        <h2 class="text-2xl font-bold text-deepBlue mt-1">
                            <span id="res-from">Start</span> 
                            <i class="fa-solid fa-chevron-right text-skyBlue mx-2 text-sm"></i> 
                            <span id="res-to">End</span>
                        </h2>
                    </div>
                    <div class="mt-4 md:mt-0">
                         <span class="animate-pulse inline-flex items-center gap-1 bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full border border-green-200">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Live Schedule
                         </span>
                    </div>
                </div>
            </div>

            <!-- SECTION 1: METRO SUGGESTIONS -->
            <div id="metro-section" class="mb-10 hidden">
                 <h3 class="text-xl font-bold text-deepBlue mb-4 flex items-center gap-2 border-b border-gray-200 pb-2">
                    <i class="fa-solid fa-train-subway text-metroPurple"></i> 
                    <span>Namma Metro Suggestions</span>
                </h3>
                <div id="metro-list" class="space-y-4"></div>
            </div>

            <!-- SECTION 2: BUSES -->
            <div>
                <h3 class="text-xl font-bold text-deepBlue mb-4 flex items-center gap-2 border-b border-gray-200 pb-2">
                    <i class="fa-solid fa-bus text-oceanBlue"></i> Available Bus Routes
                </h3>
                <div id="bus-list-container" class="space-y-5">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- ANIMATION CANVAS OVERLAY -->
    <div id="animation-container">
        <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-deepBlue">Finding Best Route...</h2>
            <p class="text-oceanBlue mt-2" id="anim-subtext">Checking BMTC & Metro Schedules</p>
        </div>
        <canvas id="routeCanvas" width="800" height="400" class="w-full max-w-3xl"></canvas>
    </div>

    <!-- TRACKING MODAL -->
    <div id="tracking-modal" class="fixed inset-0 bg-deepBlue bg-opacity-80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl h-[85vh] flex flex-col shadow-2xl overflow-hidden">
            
            <!-- Modal Header -->
            <div class="p-5 border-b bg-paleWater flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-oceanBlue text-white p-3 rounded-xl shadow-sm">
                        <i class="fa-solid fa-clock-rotate-left text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-deepBlue" id="modal-bus-name">Route Schedule</h3>
                        <p class="text-sm text-oceanBlue font-medium">Next Departure: <span id="modal-next-bus" class="font-bold text-deepBlue">--:--</span></p>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white hover:bg-red-50 text-gray-400 hover:text-red-500 transition flex items-center justify-center shadow-md">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Google Maps Link Bar -->
            <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
                <p class="text-sm text-gray-500">Need live location?</p>
                <a id="gmaps-link" href="#" target="_blank" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-map-location-dot"></i> Track on Google Maps
                </a>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <!-- Stop List -->
                <div class="overflow-y-auto p-6 flex-grow bg-white">
                    <ul id="modal-stops-list" class="space-y-0 relative border-l-2 border-gray-200 ml-3 pl-8 pb-4">
                        <!-- Stops injected here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- --- JAVASCRIPT SECTION --- -->
    <script>
        // --- HELPER TO GENERATE HIGH FREQUENCY TIMINGS ---
        function generateTimings(startHour, endHour, intervalMinutes) {
            const timings = [];
            for (let h = startHour; h <= endHour; h++) {
                for (let m = 0; m < 60; m += intervalMinutes) {
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    const displayH = h % 12;
                    const finalH = displayH === 0 ? 12 : displayH; 
                    const displayM = m.toString().padStart(2, '0');
                    timings.push(`${finalH.toString().padStart(2, '0')}:${displayM} ${ampm}`);
                }
            }
            return timings;
        }

        // --- EXPANDED BUS DATABASE (Includes JP Nagar & Main Residential Areas) ---
        const busRoutes = [
            // --- SOUTH BANGALORE (JP Nagar, Jayanagar, BTM) ---
            { 
                id: "215H", type: "Ordinary", 
                stops: ["Kempegowda Bus Station", "Corporation Circle", "Lalbagh Main Gate", "South End Circle","Jayanagar", "Jayanagar 4th Block", "Jayanagar 5th Block", "Jaya Prakash Nagar", "Jaya Prakash Nagar 6th Phase", "RBI Layout", "Konanakunte Cross","BK Circle", "Jambu Savari Dinne"], 
                timings: generateTimings(6, 22, 13)
            },
            { 
                id: "15G", type: "Ordinary", 
                stops: ["2nd stage Kumaraswamy Layout","Kumaraswamy Layout","Dayananda Sagar College","Yarab Nagar","Basavanagudi PS","National College","K R Market","Mysore Bank","Kempegowda Bus Station"], 
                timings: generateTimings(5, 21, 40)
            },
            { 
                id: "15E", type: "Ordinary", 
                stops: ["Kumaraswamy Layout","Dayananda Sagar College","Yarab Nagar","MM Industries","Basavanagudi PS","National College","K R Market","Mysore Bank","Kempegowda Bus Station"], 
                timings: generateTimings(5, 21, 22)
            },
            { 
                id: "13A", type: "Ordinary", 
                stops: ["Shivajinagara","Chinnaswamy Stadium","Shanthinagara TTMC","Ashoka Pillar","Jayanagar 4th Block","Banashankari","Kaveri Nagara","Dayananda Sagar College","Kumaraswamy Layout","2nd stage Kumaraswamy Layout"], 
                timings: generateTimings(6, 21, 25)
            },
           { 
                id: "13C", type: "Ordinary", 
                stops: ["Kumaraswamy Layout","Kumaraswamy Layout PS","Dayananda Sagar College","Kaveri Nagara","Banashankari","Jayanagar","Ashoka Pillar","Wilson Garden","Shanthinagara TTMC","MG Road","Shivajinagara"], 
                timings: generateTimings(6, 21, 20)
            },
            {
                id: "201", type: "Ordinary",
                stops: ["Srinagar", "Hanumanthnagar", "Gandhi Bazaar", "Jayanagar 4th Block", "Jayanagar 9th Block", "Jaya Prakash Nagar 3rd Phase", "Mico Layout", "BTM Layout", "Central Silk Board", "HSR Layout", "Agara", "Domlur", "Indiranagar", "CV Raman Nagar"],
                timings: generateTimings(6, 21, 15)
            },
            {
                id: "210N", type: "Ordinary", 
                stops: ["Kempegowda Bus Station", "K R Market", "Makkala Koota", "Chamarajpet", "Hanumanthnagar", "Srinagar", "Banashankari TTMC", "Kadirenahalli Park", "Kadirenahalli Cross", "Dayananda Sagar College", "Kumaraswamy Layout PS", "Kumaraswamy Layout", "ISRO Layout", "Vasanthapura", "Uttarahalli"], 
                timings: generateTimings(5, 22, 6) 
            },
            {
                id: "365", type: "Ordinary",
                stops: ["Kempegowda Bus Station", "Corporation Circle", "Shanthinagara TTMC", "Dairy Circle", "Gurappanapalya", "Jayadeva Hospital", "Bilekahalli", "Apollo Hospital", "Hulimavu", "Meenakshi Temple", "Gottigere", "Bannerughatta National Park"],
                timings: generateTimings(6, 21, 8)
            },
             { 
                id: "25A", type: "Ordinary", 
                stops: ["Kempegowda Bus Station","K R Circle", "Corporation Circle", "Lalbagh Main Gate","Ashoka Pillar","Jayanagar 4th Block","Jayanagar","Shanthinagara TTMC", "BTM Layout"], 
                timings: generateTimings(7, 21, 8) 
            },
           { 
                id: "237C", type: "Ordinary", 
                stops: ["bande Maramma","Ramakrishnappa Layout","Prashanth Nagara","Manuvana","Magadi Road","Kempegowda Bus Station","Vidhana Soudha","Ghousia Hospital","Shivajinagara"], 
                timings: generateTimings(7, 20, 46) 
            },
           { 
                id: "210AA", type: "Ordinary", 
                stops: ["Iskcon Temple Maruthinagara","ISRO Layout","Kumaraswamy Layout","Kumaraswamy Layout PS","Dayananda Sagar College","Banashankari","MM Industries","Basavanagudi","National College","K R Market","Mysore Bank","Kempegowda Bus Station"], 
                timings: generateTimings(8, 18, 55)
            },
          { 
                id: "210G", type: "Ordinary", 
                stops: ["Vasanthapura","ISRO Layout","Kumaraswamy Layout","Kumaraswamy Layout PS","Dayananda Sagar College","Kaveri Nagara","Banashankari","Jayanagar","Madhavan Park","Ashoka Pillar","Wilson Garden","Shanthinagara TTMC","st Joseph College","MG Road","Shivajinagara"], 
                timings: generateTimings(9, 19, 16)
            },
          
          

            // --- CENTRAL & EAST (Koramangala, Indiranagar, Whitefield) ---
             { 
                id: "171", type: "Ordinary", 
                stops: ["Kempegowda Bus Station","K R Circle","B S P Kalinga Rao Road","Shanthinagara TTMC", "Wilson Garden", "Dairy Circle", "Forum Mall Bus Stop","Koramangala 1st Block", "Koramangala 5th Block",  "Koramangala TTMC","Koramangala Water Tank","Jaya Prakash Nagar"], 
                timings: generateTimings(6, 22, 12) 
            },
            
            {
                id: "335G", type: "Ordinary",
                stops: ["BEML Layout","Havanur Circle","Industrial Town","Rajaji Nagar","Kempegowda Bus Station", "K R Circle", "Mallaya Hospital", "Mayo Hall", "Domlur", "HAL Main Gate", "HAL Kalyana Mantapa", "Marathahalli", "Kundalahalli Gate", "White Field", "Hope Farm", "Kadugodi"],
                timings: generateTimings(7, 19, 55)
            },
            { 
                id: "300H", type: "Ordinary", 
                stops: ["Kempegowda Bus Station", "Shivajinagara", "Ulsoor", "Indiranagar", "Byappanahalli", "K R Puram"], 
                timings: generateTimings(7, 20, 12) 
            },

            // --- NORTH & WEST (Malleshwaram, Rajajinagar, Vijayanagar, Yelahanka) ---
            { 
                id: "276", type: "Ordinary", 
                stops: ["K R Market","Kempegowda Bus Station","Mantri Mall","Malleshwaram Circle", "Malleshwaram 11th Cross", "Malleshwaram 18th Cross", "Tata Institute (IISc)", "Yeshawanthapura TTMC", "Mathikere", "Gokula", "BEL Circle","Chamundeshwari Layout", "Vidyaranyapura"], 
                timings: generateTimings(9, 20, 55) 
            },
            { 
                id: "258", type: "Ordinary", 
                stops: ["K R Market","Kempegowda Bus Station", "Malleshwaram Circle", "Rajajinagar 1st Block", "Yeshawanthapura TTMC", "Govardhan Talkies", "Peenya","Jalahalli Cross", "Dasarahalli", "Nagasandra","Madavara","Madanayakanahalli","Dasanapura","Binnamangala", "Nelamangala"], 
                timings: generateTimings(5, 19, 8) 
            },
             { 
                id: "401K", type: "Ordinary", 
                stops: ["Yelahanka New Town", "Yelahanka", "Hebbala", "BEL Circle", "Mathikere", "Yeshawanthapura TTMC", "Rajajinagar 1st Block", "Vijayanagara TTMC", "Attiguppe", "Nayandahalli", "Kengeri TTMC"], 
                timings: generateTimings(6, 21, 13) 
            },
            {
                id: "226N", type: "Ordinary",
                stops: ["Kempegowda Bus Station", "Mysore Road Satellite Bus Station", "Nayandahalli", "Rajarajeshwari Nagar Gate", "Bangalore University Gate", "Kengeri TTMC", "Kumbalgodu", "Bidadi"],
                timings: generateTimings(6, 21, 15)
            },

            // --- RING ROAD (ORR) CONNECTIONS ---
            { 
                id: "500D", type: "Volvo AC", 
                stops: ["Hebbala", "Kempapura", "Manyata Tech Park", "Nagavara", "Hennur Junction", "Kalyananagara", "Babusabpalya", "Kasturi Nagar", "Tin Factory", "K R Puram", "Mahadevapura", "Doddanekkundi", "Karthik Nagara", "Marathahalli Bridge", "Kadubisanahalli", "New Horizon College", "Devarabisanahalli", "Eco Space", "Bellandur", "Sarjapura Cross", "Ibbalur", "Agara", "HSR Layout", "Central Silk Board"], 
                timings: generateTimings(5, 23, 7) 
            },
             {
                id: "500CA", type: "Ordinary",
                stops: ["Banashankari TTMC", "Central Silk Board", "HSR Layout", "Agara", "Bellandur", "Marathahalli", "K R Puram", "Tin Factory", "Kalyananagara", "Hebbala"],
                timings: generateTimings(6, 21, 15)
            },

             // --- ELECTRONIC CITY & HOSUR ROAD ---
            {
                id: "356M", type: "Ordinary",
                stops: ["Kempegowda Bus Station", "Corporation", "Shanthinagara TTMC", "Dairy Circle", "Madiwala", "Central Silk Board", "Roopena Agrahara", "Bommanahalli", "Garvebhavipalya", "Kudlu Gate", "Singasandra", "Hosa Road", "Electronic City", "Veerasandra", "Hebbagodi", "Bommasandra", "Chandapura", "Anekal"],
                timings: generateTimings(6, 22, 18)
            },

           // --- BANASHANKARI ---
           {
                id: "12", type: "Ordinary",
                stops: ["Banashankari","Jayanagar 8th Block","Vijaya College","Lalbagh","Town Hall","Kempegowda Bus Station"],
                timings: generateTimings(6, 22, 10)
            },
          {
                id: "13", type: "Ordinary",
                stops: ["Banashankari","Jayanagar 4th Block","Jayanagar","Ashoka Pillar","Wilson Garden","Shanthinagara TTMC","st Joseph College","MG Road","Shivajinagara"],
                timings: generateTimings(6, 22, 12)
            },
          {
                id: "13B", type: "Ordinary",
                stops: ["Shivajinagara","Chinnaswamy Stadium","st Joseph's University","Shanthi Nagar","Lalbagh","Ashoka Pillar","Jayanagar","Jayanagar 4th Block","Banashankari","Kaveri Nagar","Padmanabha Nagar"],
                timings: generateTimings(7, 18, 23)
            },
           {
                id: "13E", type: "Ordinary",
                stops: ["Sri Vidyanagara","Hoskerehalli Cross","Kamkya","Kadirenalli Cross","Banashankari","Jayanagar","Madhavan Park","Ashoka Pillar","Wilson Garden","Shanthinagara TTMC","st Joseph College","MG Road","Shivajinagara"],
                timings: generateTimings(7, 17, 25)
            },
          {
                id: "13H", type: "Ordinary",
                stops: ["Shivajinagara","Chinnaswamy Stadium","st Joseph's University","Shanthinagara TTMC","Lalbagh","Ashoka Pillar","Jayanagar 3rd Block","Jayanagar","Jayanagar 4th Block","Banashankari","Kamakya","Ittamadu Cross","AGS Layout"],
                timings: generateTimings(8, 19, 53)
            },
          {
                id: "13J", type: "Ordinary",
                stops: ["Shivajinagara","Chinnaswamy Stadium","st Joseph's University","Shanthinagara TTMC","Lalbagh","Ashoka Pillar","Jayanagar 3rd Block","Jayanagar","Jayanagar 4th Block","Banashankari","Kaveri Nagar","Kadirenahalli Cross","Kamakya","Hoskerehalli"],
                timings: generateTimings(9, 17, 56)
            },
          {
                id: "13K", type: "Ordinary",
                stops: ["Shivajinagara","Chinnaswamy Stadium","Shanthinagara TTMC","Lalbagh","Ashoka Pillar","Jayanagar 3rd Block","Jayanagar","Jayanagar 4th Block","Banashankari","Kaveri Nagar","Kadirenahalli Cross","Minaznagara"],
                timings: generateTimings(9, 17, 49)
            },
           {
                id: "201G", type: "Ordinary",
                stops: ["Banashankari","Jayanagar 5th Block","Jayanagar","MICO Layout","BTM Layout Water Tank","BTM Layout","Central Silk Board","Koramangala BDA Complex","Koramangala","Military Bridge","Doopanahalli","Indiranagar 12th Main","Indiranagar","Indiranagar PS","Kodihalli","Jeevanbheema Nagar"],
                timings: generateTimings(4, 19, 22)
            },
          {
                id: "210B", type: "Ordinary",
                stops: ["Chunchaghatta","Ganapathipura","Yelachenahalli","Jaya Prakash Nagar","Banashankari","MM Industries","Basavanagudi PS","National College","K R Market","Town Hall","Kempegowda Bus Station"],
                timings: generateTimings(6, 18, 54)
            },
          {
                id: "210E", type: "Ordinary",
                stops: ["Vasanthapura","Uttarahalli","Chikkallasandra","Kadirenahalli Cross","Banashankari","Yediyur","Jayanagar 6th Block","South End Circle","Basappa Circle","Town Hall","Kempegowda Bus Station"],
                timings: generateTimings(5, 20, 28)
            },
          {
                id: "211", type: "Ordinary",
                stops: ["Somanahalli","APS College","Gandhi Nagar","Kaggalipura","udipalya","Lakshmipura","Agara Cross","Silk Institute","Thalagattapura","Raghuvanahalli Cross","Doddakallasandra","Konanakunte Cross","Yelachenahalli","Jaya Prakash Nagar","Banashankari","Jayanagar 6th Block","South End Circle","Basappa Circle","K R Market"],
                timings: generateTimings(6, 18, 53)
            },
          
          
            // --- AIRPORT (KIA) ---
            { 
                id: "KIA-4", type: "Vayu Vajra", 
                stops: ["HAL Main Gate", "Marathahalli", "Hennur Cross", "Hebbala", "Kempegowda International Airport"], 
                timings: ["03:00 AM", "05:00 AM", "07:00 AM", "09:00 AM", "11:00 AM", "01:00 PM", "03:00 PM", "05:00 PM", "07:00 PM", "09:00 PM"]
            },
            { 
                id: "KIA-8", type: "Vayu Vajra", 
                stops: ["Electronic City", "Silk Board", "HSR Layout", "Marathahalli", "Hebbala", "Kempegowda International Airport"], 
                timings: generateTimings(4, 23, 30)
            },
            { 
                id: "KIA-9", type: "Vayu Vajra", 
                stops: ["Kempegowda Bus Station", "Shivananda Circle", "Mekhri Circle", "Hebbala", "Kodigehalli Gate", "Yelahanka", "Kogilu Cross", "Sadahalli Gate", "Kempegowda International Airport"], 
                timings: generateTimings(0, 23, 20) 
            }
        ];

        // --- METRO DATABASE ---
        const metroLines = [
            {
                name: "Purple Line",
                stations: ["Whitefield", "Hope Farm", "Kadugodi", "K R Puram", "Benniganahalli", "Indiranagar", "Halasuru", "Trinity", "MG Road", "Cubbon Park", "Dr. B.R. Ambedkar Station Vidhana Soudha", "Sir M. Visvesvaraya Station", "Nadaprabhu Kempegowda Station", "City Railway Station", "Magadi Road", "Hosahalli", "Vijayanagara", "Attiguppe", "Deepanjali Nagar", "Mysore Road", "Nayandahalli", "Rajarajeshwari Nagar", "Jnanabharathi", "Pattanagere", "Kengeri Bus Terminal", "Kengeri", "Challaghatta"]
            },
            {
                name: "Green Line",
                stations: ["Nagasandra", "Dasarahalli", "Jalahalli", "Peenya Industry", "Peenya", "Goraguntepalya", "Yeshwanthpur", "Sandal Soap Factory", "Mahalakshmi", "Rajajinagar", "Kuvempu Road", "Srirampura", "Mantri Square Sampige Road", "Nadaprabhu Kempegowda Station", "Chickpete", "Krishna Rajendra Market", "National College", "Lalbagh", "South End Circle", "Jayanagar", "Rashtreeya Vidyalaya Road", "Banashankari", "Jaya Prakash Nagar", "Yelachenahalli", "Konanakunte Cross", "Doddakallasandra", "Vajarahalli", "Thalaghattapura", "Silk Institute"]
            }
        ];
        
        // --- POPULATE SEARCH LOCATIONS FROM ROUTES ---
        const locationSet = new Set();
        busRoutes.forEach(route => {
            route.stops.forEach(stop => locationSet.add(stop));
        });
        
        // Add manual important locations just in case
        ["Majestic", "KBS", "City Market", "Shivajinagar"].forEach(loc => locationSet.add(loc));

        const locations = Array.from(locationSet).sort();

        // --- DOM ELEMENTS ---
        const fromInput = document.getElementById('from-input');
        const toInput = document.getElementById('to-input');
        const fromSuggestions = document.getElementById('from-suggestions');
        const toSuggestions = document.getElementById('to-suggestions');
        const searchView = document.getElementById('search-view');
        const resultsView = document.getElementById('results-view');
        const animContainer = document.getElementById('animation-container');
        const busListContainer = document.getElementById('bus-list-container');
        const metroList = document.getElementById('metro-list');
        const metroSection = document.getElementById('metro-section');

        // --- HELPER FUNCTION FOR QUICK LINKS ---
        function fillSearch(from, to) {
            fromInput.value = from;
            toInput.value = to;
            startJourney();
        }

        // --- AUTOCOMPLETE LOGIC ---
        function setupAutocomplete(input, listElement) {
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                listElement.innerHTML = '';
                if (!value) {
                    listElement.classList.add('hidden');
                    return;
                }

                // Limit results to 10 for performance
                const filtered = locations.filter(loc => loc.toLowerCase().includes(value)).slice(0, 10);
                
                if (filtered.length > 0) {
                    listElement.classList.remove('hidden');
                    filtered.forEach(loc => {
                        const li = document.createElement('li');
                        li.className = "px-4 py-3 hover:bg-paleWater cursor-pointer text-deepBlue text-sm font-medium border-b border-gray-50 last:border-0";
                        li.textContent = loc;
                        li.onclick = () => {
                            input.value = loc;
                            listElement.classList.add('hidden');
                        };
                        listElement.appendChild(li);
                    });
                } else {
                    listElement.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== listElement) {
                    listElement.classList.add('hidden');
                }
            });
        }

        setupAutocomplete(fromInput, fromSuggestions);
        setupAutocomplete(toInput, toSuggestions);

        // Set default time to current time
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeInput = document.getElementById('time-input');
        if(timeInput) timeInput.value = `${hours}:${minutes}`;

        function swapLocations() {
            const temp = fromInput.value;
            fromInput.value = toInput.value;
            toInput.value = temp;
        }
        
        // --- TIME HELPER ---
        function convertToMinutes(timeStr) {
            if(!timeStr) return -1;
            const [time, modifier] = timeStr.split(' ');
            let [hours, minutes] = time.split(':');
            
            hours = parseInt(hours, 10);
            minutes = parseInt(minutes, 10);
            
            if (hours === 12 && modifier === 'AM') {
                hours = 0;
            }
            if (modifier === 'PM' && hours !== 12) {
                hours += 12;
            }
            
            return hours * 60 + minutes;
        }

        function minutesToTimeStr(totalMinutes) {
            let h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; // the hour '0' should be '12'
            const mStr = m < 10 ? '0' + m : m;
            return `${h}:${mStr} ${ampm}`;
        }

        // --- ANIMATION LOGIC ---
        function startJourney() {
            const fromVal = fromInput.value;
            const toVal = toInput.value;

            if(!fromVal || !toVal) {
                alert("Please select both 'From' and 'To' locations!");
                return;
            }

            animContainer.style.display = "flex";
            document.getElementById('anim-subtext').innerText = `Checking schedules for ${fromVal} to ${toVal}`;
            
            const canvas = document.getElementById('routeCanvas');
            const ctx = canvas.getContext('2d');
            
            let start = null;
            const duration = 1200; 

            const p0 = { x: 100, y: 300 }; 
            const p1 = { x: 400, y: 50 }; 
            const p2 = { x: 700, y: 300 }; 

            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const t = Math.min(progress / duration, 1); 

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.setLineDash([10, 10]);
                ctx.beginPath();
                ctx.moveTo(p0.x, p0.y);
                ctx.quadraticCurveTo(p1.x, p1.y, p2.x, p2.y);
                ctx.strokeStyle = '#0077B6';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.setLineDash([]);

                const bx = Math.pow(1-t, 2) * p0.x + 2 * (1-t) * t * p1.x + Math.pow(t, 2) * p2.x;
                const by = Math.pow(1-t, 2) * p0.y + 2 * (1-t) * t * p1.y + Math.pow(t, 2) * p2.y;

                drawLocationMarker(ctx, p0.x, p0.y, "Start", "#00B4D8");
                drawLocationMarker(ctx, p2.x, p2.y, "End", "#03045E");
                drawRedBus(ctx, bx, by);

                if (t < 1) {
                    requestAnimationFrame(animate);
                } else {
                    setTimeout(() => finishAnimation(fromVal, toVal), 300);
                }
            }
            requestAnimationFrame(animate);
        }

        function drawLocationMarker(ctx, x, y, label, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = "#03045E";
            ctx.font = "bold 14px Poppins";
            ctx.textAlign = "center";
            ctx.fillText(label, x, y + 25);
        }

        function drawRedBus(ctx, x, y) {
            ctx.save();
            ctx.translate(x - 25, y - 15);
            ctx.fillStyle = "#D62828";
            ctx.beginPath();
            ctx.roundRect(0, 0, 60, 30, 5);
            ctx.fill();
            ctx.fillStyle = "#333";
            ctx.fillRect(5, 5, 12, 10);
            ctx.fillRect(20, 5, 12, 10);
            ctx.fillRect(35, 5, 12, 10);
            ctx.fillStyle = "#222";
            ctx.fillRect(40, 5, 10, 25);
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(12, 30, 6, 0, Math.PI * 2); 
            ctx.arc(48, 30, 6, 0, Math.PI * 2); 
            ctx.fill();
            ctx.fillStyle = "#888";
            ctx.beginPath();
            ctx.arc(12, 30, 3, 0, Math.PI * 2); 
            ctx.arc(48, 30, 3, 0, Math.PI * 2); 
            ctx.fill();
            ctx.restore();
        }

        function finishAnimation(from, to) {
            animContainer.style.display = "none";
            searchView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            document.getElementById('res-from').innerText = from;
            document.getElementById('res-to').innerText = to;
            
            findAndDisplayBuses(from, to);
            findAndDisplayMetro(from, to);
        }

        // --- METRO LOGIC ---
        function findAndDisplayMetro(from, to) {
            metroList.innerHTML = '';
            metroSection.classList.add('hidden');

            const fLower = from.toLowerCase();
            const tLower = to.toLowerCase();
            
            // Heuristic to check if location matches a station roughly
            // Note: This is a simple substring check. Real world needs fuzzy matching.
            
            let startStation = null;
            let endStation = null;
            let line = null;

            metroLines.forEach(l => {
                const s1 = l.stations.find(s => fLower.includes(s.toLowerCase()) || s.toLowerCase().includes(fLower));
                const s2 = l.stations.find(s => tLower.includes(s.toLowerCase()) || s.toLowerCase().includes(tLower));
                
                if (s1 && s2) {
                    startStation = s1;
                    endStation = s2;
                    line = l;
                }
            });

            // Special Case: KBS is Nadaprabhu Kempegowda Station
            if(fLower.includes("kempegowda bus") || fLower.includes("majestic") || fLower.includes("kbs")) {
                const l = metroLines[0]; // Purple
                const s = l.stations.find(st => st.includes("Kempegowda Station"));
                if(!startStation) startStation = s;
            }
             if(tLower.includes("kempegowda bus") || tLower.includes("majestic") || tLower.includes("kbs")) {
                const l = metroLines[0]; // Purple
                const s = l.stations.find(st => st.includes("Kempegowda Station"));
                if(!endStation) endStation = s;
            }


            if (startStation && endStation) {
                metroSection.classList.remove('hidden');
                const div = document.createElement('div');
                const lineColor = line.name.includes("Purple") ? "border-purple-500" : "border-green-500";
                const badgeColor = line.name.includes("Purple") ? "bg-purple-100 text-purple-700" : "bg-green-100 text-green-700";
                
                div.className = `metro-card p-5 rounded-xl shadow-sm border-l-8 ${lineColor}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-100 p-3 rounded-full">
                                <i class="fa-solid fa-train text-gray-700 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-deepBlue">Metro Available</h4>
                                <div class="text-sm text-gray-600">
                                    Board at <span class="font-bold">${startStation}</span> 
                                    <i class="fa-solid fa-arrow-right mx-1 text-xs"></i> 
                                    Alight at <span class="font-bold">${endStation}</span>
                                </div>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${badgeColor}">
                            ${line.name}
                        </span>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 pl-14">
                        <i class="fa-regular fa-clock"></i> Frequency: Every 5-10 mins
                    </div>
                `;
                metroList.appendChild(div);
            }
        }

        // --- ROUTING & RESULTS ---
        function findAndDisplayBuses(from, to) {
            busListContainer.innerHTML = '';
            
            // Get user input time in minutes
            const timeVal = timeInput.value;
            let userMinutes = -1;
            if(timeVal) {
                const [h, m] = timeVal.split(':');
                userMinutes = parseInt(h) * 60 + parseInt(m);
            }

            // --- IMPROVED SEARCH LOGIC ---
            // 1. Matches Direct Buses (Forward)
            // 2. Matches Direct Buses (Reverse)
            
            const results = [];

            busRoutes.forEach(bus => {
                const fIdx = bus.stops.findIndex(s => s.toLowerCase().includes(from.toLowerCase()));
                const tIdx = bus.stops.findIndex(s => s.toLowerCase().includes(to.toLowerCase()));
                
                if (fIdx !== -1 && tIdx !== -1) {
                    if (tIdx > fIdx) {
                         // Forward Journey found
                         results.push({ bus: bus, reverse: false });
                    } else {
                         // Reverse Journey found
                         results.push({ bus: bus, reverse: true });
                    }
                }
            });
            
            // --- CONNECTING ROUTE LOGIC (Simple) ---
            // If no results, check if we can suggest a bus to Majestic (KBS)
            const isDestinationKBS = to.toLowerCase().includes("kempegowda") || to.toLowerCase().includes("majestic") || to.toLowerCase().includes("kbs");
            
            if (results.length === 0 && !isDestinationKBS) {
                 // Try finding a bus from Source -> KBS
                 busRoutes.forEach(bus => {
                    const fIdx = bus.stops.findIndex(s => s.toLowerCase().includes(from.toLowerCase()));
                    const kbsIdx = bus.stops.findIndex(s => s.includes("Kempegowda Bus Station"));
                    
                    if (fIdx !== -1 && kbsIdx !== -1) {
                         // Add this as a "Suggestion"
                         if(kbsIdx > fIdx) results.push({ bus: bus, reverse: false, isSuggestion: true });
                         else results.push({ bus: bus, reverse: true, isSuggestion: true });
                    }
                 });
            }

            if (results.length === 0) {
                busListContainer.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-paleWater col-span-2">
                        <i class="fa-solid fa-route text-5xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-deepBlue">No direct bus found.</h3>
                        <p class="text-oceanBlue mt-2 px-4">We couldn't find a direct bus or a simple connection to Majestic.</p>
                        <p class="text-sm text-gray-500 mt-1">Try searching for a nearby landmark.</p>
                        <button onclick="goBack()" class="mt-6 bg-oceanBlue text-white px-6 py-2 rounded-full font-bold hover:bg-deepBlue transition">Try New Search</button>
                    </div>`;
                return;
            }

            // --- RENDER FUNCTION ---
            results.forEach(item => {
                const { bus, reverse, isSuggestion } = item;
                
                // Calculate details based on direction
                let startStop = "";
                let endStop = "";
                let stopsCount = 0;
                
                if (!reverse) {
                    const fIdx = Math.max(0, bus.stops.findIndex(s => s.toLowerCase().includes(from.toLowerCase())));
                    const tIdx = isSuggestion ? bus.stops.findIndex(s => s.includes("Kempegowda Bus Station")) : Math.max(1, bus.stops.findIndex(s => s.toLowerCase().includes(to.toLowerCase())));
                    
                    startStop = bus.stops[fIdx];
                    endStop = bus.stops[tIdx];
                    stopsCount = Math.abs(tIdx - fIdx);
                } else {
                    const fIdx = bus.stops.findIndex(s => s.toLowerCase().includes(from.toLowerCase()));
                    const tIdx = isSuggestion ? bus.stops.findIndex(s => s.includes("Kempegowda Bus Station")) : bus.stops.findIndex(s => s.toLowerCase().includes(to.toLowerCase()));
                    
                    startStop = bus.stops[fIdx];
                    endStop = bus.stops[tIdx];
                    stopsCount = Math.abs(fIdx - tIdx);
                }
                
                const duration = stopsCount * 4 + 10; 

                // Timing Logic (Simplified for reverse: we assume same frequency)
                let displayTimes = bus.timings;
                if(userMinutes !== -1) {
                    const validTimings = bus.timings.filter(t => {
                       const min = convertToMinutes(t);
                       return min >= userMinutes; 
                    });
                    if (validTimings.length > 0) displayTimes = validTimings;
                }
                
                const timeStr = displayTimes.slice(0, 4).join(", ");
                const moreCount = Math.max(0, displayTimes.length - 4);

                const card = document.createElement('div');
                card.className = "bus-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-6";
                
                const isAC = bus.type.includes("Volvo") || bus.type.includes("Vayu");
                const badgeColor = isAC ? "bg-oceanBlue text-white" : "bg-skyBlue text-white";
                
                let suggestionBanner = '';
                if(isSuggestion) {
                    card.classList.add("border-yellow-400");
                    card.style.borderLeft = "5px solid #FBBF24";
                    suggestionBanner = `<div class="w-full bg-yellow-50 text-yellow-800 text-xs px-3 py-1 mb-2 rounded font-bold border border-yellow-200"><i class="fa-solid fa-lightbulb mr-1"></i> Suggestion: Take this to Majestic (KBS) and change bus</div>`;
                }

                const displayBusId = reverse ? `${bus.id} (Return)` : bus.id;

                card.innerHTML = `
                    <div class="w-full">
                        ${suggestionBanner}
                        <div class="flex flex-col md:flex-row justify-between items-center gap-5">
                            <div class="flex items-center gap-5 w-full md:w-auto">
                                <div class="h-16 w-16 rounded-xl ${badgeColor} flex flex-col items-center justify-center shadow-md flex-shrink-0">
                                    <span class="text-xl font-bold">${bus.id.split('-')[0]}</span>
                                    <span class="text-[10px] uppercase">${bus.id.split('-')[1] || ''}</span>
                                </div>
                                <div class="flex-grow">
                                    <div class="flex items-center gap-3">
                                        <h3 class="font-bold text-2xl text-deepBlue">${displayBusId}</h3>
                                        <span class="text-xs px-2 py-1 rounded bg-paleWater text-oceanBlue font-semibold uppercase tracking-wide border border-skyBlue">${bus.type}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Towards: <span class="font-semibold text-oceanBlue">${reverse ? bus.stops[0] : bus.stops[bus.stops.length-1]}</span></p>
                                    <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">
                                        <i class="fa-regular fa-clock mr-1 text-oceanBlue"></i> 
                                        <span class="font-semibold text-deepBlue">${timeStr}</span>
                                        ${moreCount > 0 ? `<span class="text-xs text-gray-400 ml-1">(+${moreCount} more)</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-8 text-sm w-full md:w-auto justify-between md:justify-center bg-paleWater p-3 rounded-lg md:bg-transparent md:p-0">
                                <div class="text-center">
                                    <p class="font-bold text-deepBlue text-lg">${stopsCount}</p>
                                    <p class="text-xs text-oceanBlue uppercase">Stops</p>
                                </div>
                                <div class="w-px h-8 bg-skyBlue hidden md:block"></div>
                                <div class="text-center">
                                    <p class="font-bold text-deepBlue text-lg">~${duration} <span class="text-sm font-normal">min</span></p>
                                    <p class="text-xs text-oceanBlue uppercase">Duration</p>
                                </div>
                            </div>

                            <button onclick='openTracking("${bus.id}", "${from}", "${isSuggestion ? "Kempegowda Bus Station" : to}", ${reverse})' class="w-full md:w-auto bg-deepBlue hover:bg-oceanBlue text-white font-semibold px-6 py-3 rounded-lg transition shadow-md flex items-center justify-center gap-2 group">
                                <span>Track Bus</span>
                                <i class="fa-solid fa-location-dot group-hover:animate-bounce"></i>
                            </button>
                        </div>
                    </div>
                `;
                busListContainer.appendChild(card);
            });
        }

        function goBack() {
            resultsView.classList.add('hidden');
            searchView.classList.remove('hidden');
        }

        // --- TRACKING MODAL LOGIC (UPDATED FOR REVERSE) ---
        function openTracking(busId, from, to, isReverse) {
            const bus = busRoutes.find(b => b.id === busId);
            if (!bus) return;

            // Determine Stops Order based on direction
            let stopsToRender = [...bus.stops];
            if (isReverse) {
                stopsToRender = stopsToRender.reverse();
            }

            const endStop = stopsToRender[stopsToRender.length-1];
            document.getElementById('modal-bus-name').innerHTML = `${busId} <span class="text-base font-normal text-gray-500">towards ${endStop}</span>`;
            document.getElementById('tracking-modal').classList.remove('hidden');

            const listEl = document.getElementById('modal-stops-list');
            listEl.innerHTML = '';
            
            // Find Indices for highlighting in the *rendered* list
            const startIdx = stopsToRender.findIndex(s => s.toLowerCase().includes(from.toLowerCase()));
            const endIdx = stopsToRender.findIndex(s => s.toLowerCase().includes(to.toLowerCase()));
            
            // Calculate Next Departure (Simplified)
            let searchTimeMin = 0;
            const timeInputValue = document.getElementById('time-input').value;
            if(timeInputValue) {
                const [h, m] = timeInputValue.split(':');
                searchTimeMin = parseInt(h) * 60 + parseInt(m);
            } else {
                const now = new Date();
                searchTimeMin = now.getHours() * 60 + now.getMinutes();
            }

            let nextBusTimeMin = -1;
            for (let t of bus.timings) {
                const busMin = convertToMinutes(t);
                if (busMin >= searchTimeMin) {
                    nextBusTimeMin = busMin;
                    break;
                }
            }
            if (nextBusTimeMin === -1 && bus.timings.length > 0) nextBusTimeMin = convertToMinutes(bus.timings[0]);

            const nextDepartureStr = minutesToTimeStr(nextBusTimeMin);
            document.getElementById('modal-next-bus').innerText = nextDepartureStr;

            // Render Stops
            stopsToRender.forEach((stop, index) => {
                const li = document.createElement('li');
                
                let isActive = false;
                let isPast = false;
                
                if (startIdx !== -1 && endIdx !== -1) {
                    if (index >= startIdx && index <= endIdx) isActive = true;
                    if (index < startIdx) isPast = true;
                }
                
                // Assume 4 minutes per stop
                const minutesFromStart = index * 4; 
                const arrivalAtStopMin = nextBusTimeMin + minutesFromStart;
                let finalMin = arrivalAtStopMin % 1440;
                const timeString = minutesToTimeStr(finalMin);

                const borderClass = isActive ? "border-l-4 border-oceanBlue" : "border-l-2 border-dashed border-gray-200";
                const bgClass = isActive ? "bg-blue-50 rounded-lg shadow-sm" : "";
                const textClass = isActive ? "text-deepBlue font-bold text-lg" : (isPast ? "text-gray-400" : "text-gray-600");
                const opacityClass = isActive ? "opacity-100" : "opacity-60";
                
                let dotHtml = '';
                if(index === startIdx) {
                      dotHtml = `<div class="absolute -left-[41px] top-5 w-5 h-5 rounded-full bg-green-500 ring-4 ring-green-100 border-2 border-white shadow-md z-10 flex items-center justify-center"><i class="fa-solid fa-play text-[8px] text-white ml-0.5"></i></div>`;
                } else if(index === endIdx) {
                      dotHtml = `<div class="absolute -left-[41px] top-5 w-5 h-5 rounded-full bg-red-500 ring-4 ring-red-100 border-2 border-white shadow-md z-10 flex items-center justify-center"><i class="fa-solid fa-flag-checkered text-[8px] text-white"></i></div>`;
                } else if (isActive) {
                      dotHtml = `<div class="absolute -left-[37px] top-6 w-3 h-3 rounded-full bg-oceanBlue border-2 border-white"></div>`;
                } else {
                      dotHtml = `<div class="absolute -left-[37px] top-6 w-3 h-3 rounded-full bg-gray-300 border-2 border-white"></div>`;
                }

                li.className = `relative mb-4 last:mb-0 transition-all duration-300`;
                li.innerHTML = `
                    ${dotHtml}
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 ${bgClass} ${borderClass} ${opacityClass}">
                        <div class="flex-grow">
                            <div class="${textClass}">
                                ${stop}
                            </div>
                            ${index === startIdx ? '<span class="inline-block mt-1 text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">Boarding Point</span>' : ''}
                            ${index === endIdx ? '<span class="inline-block mt-1 text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">Drop Location</span>' : ''}
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 text-right min-w-[80px]">
                            <div class="text-xs text-gray-400 uppercase tracking-wider mb-0.5">Approx</div>
                            <div class="text-xl font-bold text-deepBlue font-mono">
                                ${timeString}
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(li);
            });

            const origin = encodeURIComponent(from + ", Bangalore, Karnataka");
            const destination = encodeURIComponent(to + ", Bangalore, Karnataka");
            const gmapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=transit`;
            document.getElementById('gmaps-link').href = gmapsUrl;
        }

        function closeModal() {
            document.getElementById('tracking-modal').classList.add('hidden');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('tracking-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
